require 'spec_helper'
require 'ohai'
require 'ohai/mixin/docker_metadata'

describe Ohai::Mixin::DockerMetadata do
  let(:mixin) {
    metadata_object = Object.new.extend(Ohai::Mixin::DockerMetadata)
    http_client = double("Net::HTTP client")
    http_client.stub(:get).and_return(response)
    metadata_object.stub(:http_client).and_return(:http_client)
    metadata_object
  }

  describe "#http_client" do
    let(:client) { double("Net::HTTP client object") }
    let(:http_client) { double("Net::HTTP client")}
    
    before do
      http_client.stub(:start).and_return(client)
    end

    context "when socket file exists" do
      before do
        ::File.stub(:exists?).with("unix:///var/run/docker.sock").and_return(true)
      end

      it "should establish connection using a socket file" do
        http_client.should receive(:start).with("unix:///var/run/docker.sock")
      end
    end

    context "when socket file does not exist" do
      before do
        ::File.stub(:exists?).with("unix:///var/run/docker.sock").and_return(false)
      end

      it "should establish connection using default TCP endpoint" do
        http_client.should receive(:start).with("localhost", 4243)
      end
    end
  end
end
